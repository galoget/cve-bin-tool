FROM python:3.11.2-bullseye
MAINTAINER Galoget Latorre <galoget [dot] latorre [at] hackem [dot] org>

LABEL name="CVE Binary Tool - Docker Dev Environment"
LABEL maintainer="Galoget Latorre <galoget [dot] latorre [at] hackem [dot] org>"
LABEL description="Creates a ready to use/run development environment based on Debian Bullseye and Python 3.11.2 to ease the collaboration process with CVE Binary Tool"
LABEL url="https://hub.docker.com/r/galoget/cve-bin-tool"
LABEL support="https://linkedin.com/in/galoget"
LABEL command="sudo docker run -v --rm -h cve-bin-tool-lab -it cve-bin-tool"
LABEL build_date="2023-02-25T22:23:24Z"
LABEL version=1.0.0

# Change shell type to use BASH (to be able to use 'source' command)
SHELL ["/bin/bash", "-c"]

# Install basic dev tools
RUN apt update
RUN apt install -y sudo git vim nano netcat curl wget net-tools pylint

# Create new user researcher
RUN useradd -ms /bin/bash researcher

# Add researcher user to sudoers file
# User researcher will have sudo privileges and won't ask for password
# Change security measures if required, this environment is just for testing
RUN sed -i 's/^\(# User privi.*\)/\1\nresearcher     ALL=(ALL) NOPASSWD:ALL/g' /etc/sudoers

# Change the working directory to researcher home directory
WORKDIR /home/researcher/

# Change to user researcher
USER researcher

# Add Python 'bin' directory to PATH (.bashrc)
RUN echo -e "\n\n# Add Python 'bin' directory to PATH\nexport PATH=/home/researcher/.local/bin:$PATH" >> /home/researcher/.bashrc

# Add Python 'bin' directory to PATH (runtime environment variable)
ENV PATH="/home/researcher/.local/bin:$PATH"

# Upgrade pip
RUN pip install --upgrade pip

# Clone repo (This way we will always get the latest version of the code)
RUN git clone --progress --verbose https://github.com/intel/cve-bin-tool.git

# Change the working directory to cve-bin-tool directory
WORKDIR /home/researcher/cve-bin-tool

# Install pytest
RUN pip install pytest

# Install basic requirements
RUN pip install -U -r requirements.txt

# Install dev requirements
RUN pip install -r dev-requirements.txt

# Install cve-bin-tool from source code in the Docker container
RUN python3 -m pip install -e .

# When using "docker run", we will get a shell into the container
ENTRYPOINT ["/bin/bash"]

# To run this image use:
# sudo docker run --rm -h cve-bin-tool-lab -it cve-bin-tool
